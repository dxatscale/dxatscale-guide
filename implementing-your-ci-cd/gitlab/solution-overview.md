# Solution Overview

In order to configure DX@Scale with **GitLab**, there are a number of key features that need to be setup on the platform before executing the pipeline. Whether you are new to GitLab or have prior experience developing CI/CD for other software stacks on GitLab, this guide is meant to summarize the key configuration steps on the platform and use the templates provided in our [sample repository](https://github.com/dxatscale/dxatscale-template).

For a deeper dive on the platform, documentation is available on [GitLab Docs](https://docs.gitlab.com).

## GitLab Overview

![GitLab Architecture](<../../.gitbook/assets/image (23) (1).png>)

| Feature                  | Summary                                                                                                                                                                                                                                                                                                      |
| ------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Organization**         | Top level hierarchy in GitLab used to configure your users and access to projects.                                                                                                                                                                                                                           |
| **Project**              | [Projects](https://docs.gitlab.com/ee/user/project/) are used to host your codebase, track issues, plan work, collaborate on code, and continuously build, test, and use built-in CI/CD to deploy your app.                                                                                                  |
| **Repository**           | Store your code in metadata [source format](https://developer.salesforce.com/docs/atlas.en-us.sfdx\_dev.meta/sfdx\_dev/sfdx\_dev\_source\_file\_format.htm) and make changes to it. Your changes are tracked with version control.                                                                           |
| **Issues**               | [Collaborate](https://docs.gitlab.com/ee/user/project/issues/) on ideas, solve problems, and plan work.                                                                                                                                                                                                      |
| **CI/CD**                | <p>Tooling built into GitLab for software development through the <a href="https://docs.gitlab.com/ee/ci/">continuous methodologies</a>:</p><ul><li>Continuous Integration (CI)</li><li>Continuous Delivery (CD)</li><li>Continuous Deployment (CD)</li></ul>                                                |
| **Package & Repository** | Acts as a private or public registry for a variety of common package managers and allows publishing and sharing packages. Project Level scoped [npm](https://docs.gitlab.com/ee/user/packages/npm\_registry/) packages are used for the solution.                                                            |
| **Settings**             | Update general project settings, merge request approvals, default and protected branches, access tokens, CI/CD variables.                                                                                                                                                                                    |
| **Others**               | <p>Additional menu options in GitLab such as Project Information, Security &#x26; Compliance, Deployments, Monitor, Infrastructure, Analytics, Wiki, and</p><p>Snippets.</p>                                                                                                                                 |
| **Member**               | Users and groups who have access to your project. Each [member](https://docs.gitlab.com/ee/user/project/members/) gets a role, which determines what they can do in the project.                                                                                                                             |
| **Group**                | A [group](https://docs.gitlab.com/ee/user/group/) is used to manage one or more related projects at the same time.                                                                                                                                                                                           |
| **Subgroup**             | [Nested groups](https://docs.gitlab.com/ee/user/group/subgroups/) or hierarchical groups.                                                                                                                                                                                                                    |
| **User**                 | Each GitLab account has a [user](https://docs.gitlab.com/ee/user/project/members/#add-users-to-a-project) profile, which contains information about you and your GitLab activity. Set up of Personal Access Tokens and SSH Keys will enable users to to securely access the GitLab API from their computers. |
| **Roles**                | Users have different abilities depending on the [role](https://docs.gitlab.com/ee/user/permissions.html) they have in a particular group or project. The roles available in GitLab are **Owner, Maintainer, Developer, Reporter and Guest.**                                                                 |

## GitLab Terminology

| Area                                                                                                                    | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| ----------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [**Anchors**](https://docs.gitlab.com/ee/ci/yaml/#anchors)                                                              | Used to duplicate or inherit properties. The template leverages anchors for reusable rules based on merge requests, merges, and manual executions of the pipeline.                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| [**Artifacts**](https://docs.gitlab.com/ee/ci/yaml/#artifacts)                                                          | List of files and directories to attach to a job when it succeeds, fails, or always. Artifacts are use to output [pmd](https://pmd.github.io/latest/pmd\_rules\_apex.html) reports, scratch org prepare logs, and quick build artifacts from the runner that are not published to artifact registry.                                                                                                                                                                                                                                                                                                        |
| [**before\_script**](https://docs.gitlab.com/ee/ci/yaml/#before\_script)                                                | Override a set of commands that are executed before job scripts. The before\_script commands are concatenated with any scripts you specify in the main script. The template uses the before\_script to authenticate to the DevHub, configure access to the npm package registry, sets git repository url to allow for pushing git tags and committing change log files.                                                                                                                                                                                                                                     |
| [**Custom Variables**](https://docs.gitlab.com/ee/ci/variables/#create-a-custom-cicd-variable-in-the-gitlab-ciyml-file) | Custom variable in the .gitlab-ci.yml file can be defined in the top level or the job level.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| [**Dependencies**](https://docs.gitlab.com/ee/ci/yaml/#dependencies)                                                    | Restrict which artifacts are passed to a specific job by providing a list of jobs to fetch artifacts from. Dependencies are used in the template to pass artifacts from the quickbuild stage to the deploy stage to push code to the Shared Developer Sandbox during code merges.                                                                                                                                                                                                                                                                                                                           |
| [**Environments**](https://docs.gitlab.com/ee/ci/yaml/#environment)                                                     | Name of an environment to which the job deploys. The template defines environments for the deploy-env, build-env, ST, SIT, UAT, and PROD environments.                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| [**Extends**](https://docs.gitlab.com/ee/ci/yaml/#extends)                                                              | Used for reuse configuration sections defined above in the Anchors for merge requests, merge, and manual execution rules in the pipeline.                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| [**Jobs**](https://docs.gitlab.com/ee/ci/jobs/)                                                                         | Pipeline configuration begins with jobs. Jobs are picked up by runners and executed in the environment of the runner. Jobs defined in the template follow the DX@Scale best practices from validate to release.                                                                                                                                                                                                                                                                                                                                                                                             |
| [**Needs**](https://docs.gitlab.com/ee/ci/yaml/#needs)                                                                  | Execute jobs earlier than the stage ordering and ensures previous jobs in the pipeline are completed before moving to the next stage and job.                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| [**.npmrc**](https://docs.gitlab.com/ee/user/packages/workflows/project\_registry.html#npm)                             | The [npm config file](https://docs.npmjs.com/cli/v7/configuring-npm/npmrc) that is configured to allow publishing and sharing packages.                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| [**Pipeline**](https://docs.gitlab.com/ee/ci/pipelines/)                                                                | Pipelines are the top-level component of continuous integration, delivery, and deployment. Pipeline comprise of jobs, which define what to do and stages, which define when to run the jobs.                                                                                                                                                                                                                                                                                                                                                                                                                |
| [**Predefined Variables**](https://docs.gitlab.com/ee/ci/variables/predefined\_variables.html)                          | Predefined CI/CD variables are available in every GitLab CI/CD pipeline.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| [**Project Access Tokens**](https://docs.gitlab.com/ee/user/project/settings/project\_access\_tokens.html)              | Similar to [personal access tokens](https://docs.gitlab.com/ee/user/profile/personal\_access\_tokens.html) but are used by projects to authenticate with the GitLab API and are supported on GitLab SaaS Premium and above as well as self-managed instances on Free tier and above. [API access](https://docs.gitlab.com/ee/user/project/settings/project\_access\_tokens.html#limiting-scopes-of-a-project-access-token) grants complete read/write access to the scoped project API, including the Package Registry. This is required for the template to push git tags and changelog to the repository. |
| [**Resource Groups**](https://docs.gitlab.com/ee/ci/yaml/#resource\_group)                                              | Used for concurrency control in the pipeline. The keyword is added to the deploy, build, and environment release jobs to ensure runners are prevented from executing jobs concurrently during execution.                                                                                                                                                                                                                                                                                                                                                                                                    |
| [**Roles**](https://docs.gitlab.com/ee/user/permissions.html)                                                           | Users have different abilities depending on the role they have in a particular group or project. If a user is both in a project’s group and the project itself, the highest role is used.                                                                                                                                                                                                                                                                                                                                                                                                                   |
| [**Rules**](https://docs.gitlab.com/ee/ci/yaml/#rules)                                                                  | List of conditions to evaluate and determine selected attributes of a job, and whether or not it’s created.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| [**Runners**](https://docs.gitlab.com/runner/)                                                                          | GitLab Runner is an application that works with GitLab CI/CD to run jobs in a pipeline.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| [**Script**](https://docs.gitlab.com/ee/ci/yaml/#script)                                                                | Specify commands for the runner to execute. Most scripts in the template leverage `sfpowerscripts:orchestrator` commands during execution.                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| [**SSH Keys**](https://docs.gitlab.com/ee/ssh/index.html#gitlab-and-ssh-keys)                                           | GitLab uses the SSH protocol to securely communicate with Git. When you use SSH keys to authenticate to the GitLab remote server, you don’t need to supply your username and password each time.                                                                                                                                                                                                                                                                                                                                                                                                            |
| [**Stage**](https://docs.gitlab.com/ee/ci/yaml/#stage)                                                                  | Define which stage a job runs in. Jobs in the same stage can execute in parallel.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| [**Variables**](https://docs.gitlab.com/ee/ci/variables/)                                                               | CI/CD variables are a type of environment variable                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |

## Security Design

There are a number of security considerations that need to factored into the setup of your GitLab project and pipeline. The following list will walk you through some considerations as you use the template and customize your pipelines for deployments.

* [Project and group visibility](https://docs.gitlab.com/ee/public\_access/public\_access.html#project-and-group-visibility) - GitLab allows **Owners** to set a project’s or group’s visibility as **Public**, **Internal**, **Private.** For most implementations, **Private** should be the preferred option.
* [Merge Request Approvals](https://docs.gitlab.com/ee/user/admin\_area/merge\_requests\_approvals.html#merge-request-approval-rules) - Approval rules can be defined for merge requests to limit who can merge to certain branches
* [Protected Branches](https://docs.gitlab.com/ee/user/project/protected\_branches.html#protected-branches) - Permissions are fundamentally defined around the idea of having read or write permission to the repository and branches. To impose further restrictions on certain branches, they can be protected. At a minimum, the **main branch** should be protected and certain **releases branches** created from main should be candidates for protection.
* [Permission and Roles](https://docs.gitlab.com/ee/user/permissions.html) - Users have different abilities depending on the role they have in a particular group or project. Review the structure of your team and confirm who to designate as **Maintainers** and who are primary **Developers**.
* [CI/CD Variable Types](https://docs.gitlab.com/ee/ci/variables/#cicd-variable-types) - Project, group and instance CI/CD variables can be **Variable** or **File** type. File type CI/CD variables are used in the template for storing [sfdxurl](https://developer.salesforce.com/docs/atlas.en-us.sfdx\_cli\_reference.meta/sfdx\_cli\_reference/cli\_reference\_auth\_sfdxurl.htm) file as input for authentication to Salesforce instances. **Protect variable** and **Mask variable** should be reviewed for each variable defined in the project to ensure that variables masked in job logs and can only run on protected branches or tags.
* [Using external secrets in CI](https://docs.gitlab.com/ee/ci/secrets/) - Secrets represent sensitive information your CI job needs to complete work. This sensitive information can be items like API tokens, database credentials, or private keys. Secrets are sourced from your secrets provider.
* [Integrations](https://docs.gitlab.com/ee/user/project/integrations/overview.html) - Integrations allow you to integrate GitLab with other applications. Review current active integrations and determine which applications make sense to integrate to GitLab. [Webhooks](https://docs.gitlab.com/ee/user/project/integrations/webhooks.html#webhooks) can be used in GitLabs but Integrations are preferred.
* [Project Access Tokens](https://docs.gitlab.com/ee/user/project/settings/project\_access\_tokens.html) - Creation and rotation of project access tokens should be reviewed for configuring access to the GitLab API and the project.
* [SSH Keys](https://docs.gitlab.com/ee/ssh/index.html#gitlab-and-ssh-keys) and [Personal Access Tokens](https://docs.gitlab.com/ee/user/profile/personal\_access\_tokens.html#personal-access-tokens) - Depending on security guidelines, each contributor to your project repository should create these to streamline secure access.

## Configuration File

The [.gitlab-ci.yml](https://docs.gitlab.com/ee/ci/yaml/gitlab\_ci\_yaml.html) template file is the primary configuration file used for executing continuous integration, delivery and deployment on the platform. This CI/CD configuration file exists by default in the root directory of your repository and controls pipeline execution of stages and jobs triggered from updates to the repository via merge requests/merges, scheduled executions, or manual execution of the pipeline.

![](<../../.gitbook/assets/image (24) (1).png>)

In the template file provided, the structure of the [YAML](https://yaml.org) file follows the following structure:

![Template Code Structure](<../../.gitbook/assets/image (36) (1).png>)

| Section                     | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| --------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Comments**                | General header for DX@Scale Template for GitLab and reference links to review.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Project CI/CD Variables** | Initial project Project CI/CD Variables required to be created in the project to authenticate and setup DevHub, Production and Sandbox Environment aliases, NPM Scope for artifacts, Project Access Tokens, and optional dashboard connection details for DataDog or New Relic.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **Image**                   | Docker image to use for the job, defaulted to the [docker-sfpowerscripts](https://hub.docker.com/r/dxatscale/sfpowerscripts) image running on Ubuntu.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Variables**               | <p>Custom and Predefined variables are used in the .gitlab-ci.yml during pipeline execution.</p><p><br><a href="https://docs.gitlab.com/ee/ci/variables/#add-a-cicd-variable-to-a-project">Custom Project Variables</a><br></p><ul><li>DEVHUB_ALIAS</li><li>DEVHUB_SFDX_AUTH_URL</li><li>SHAREDDEV_ALIAS</li><li>SHAREDDEV_SFDX_AUTH_URL</li><li>ST_ALIAS</li><li>ST_SFDX_AUTH_URL</li><li>UAT_ALIAS</li><li>UAT_SFDX_AUTH_URL</li><li>PROD_ALIAS</li><li>PROD_SFDX_AUTH_URL</li><li>NPM_SCOPE</li><li>PROJECT_ACCESS_TOKEN</li><li>SFPOWERSCRIPTS_DATADOG_HOST <em>(Optional)</em></li><li>SFPOWERSCRIPTS_DATADOG_API_KEY <em>(Optional)</em></li><li>SFPOWERSCRIPTS_NEWRELIC <em>(Optional)</em></li><li>SFPOWERSCRIPTS_NEWRELIC_API_KEY <em>(Optional)</em></li></ul><p><a href="https://docs.gitlab.com/ee/ci/variables/predefined_variables.html">Predefined Variables</a></p><ul><li>CI_PROJECT_ID</li><li>CI_SERVER_HOST</li><li>CI_JOB_TOKEN</li><li>CI_PROJECT_PATH</li><li>CI_PIPELINE_SOURCE</li><li>CI_COMMIT_BRANCH</li><li>CI_PIPELINE_ID</li></ul><p><a href="https://docs.gitlab.com/ee/ci/variables/#create-a-custom-cicd-variable-in-the-gitlab-ciyml-file">.gitlab-ci.yml Variables</a></p><ul><li>BUILD_BRANCH</li><li>SCRATCH_ORG_USERNAME</li><li>TARGETTASKNAME</li></ul> |
| **DevHub Authentication**   | [SFDX auth URL](https://developer.salesforce.com/docs/atlas.en-us.sfdx\_cli\_reference.meta/sfdx\_cli\_reference/cli\_reference\_auth\_sfdxurl.htm) is used to authorize the DevHub. Subsequent scripts in the pipeline jobs will use the DevHub alias during the deployment lifecycle. The account used in this authentication should be a dedicated CI/CD service account.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **NPM Configuration**       | Setup of the [npm config file](https://docs.npmjs.com/cli/v7/configuring-npm/npmrc) used to allow publishing and sharing packages in the Project Package Registry is generated here using the NPM Scope defined in the Project Variables and predefined variables.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Git Repo Configuration**  | In order to push git tags and change logs to the remote repository for the project from the Runners, the project access token is used here to initialize the remote url.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Stages**                  | Predefined stages for the deployment lifecycle for DX@Scale is baseline here from validate to release and preparing and cleaning scratch org pools.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Anchors**                 | Reusable rules are created here based on merge requests, merges, and manual executions of the pipeline to be later referenced in jobs for execution.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Trigger Job(s)**          | Each job in the pipeline is controlled by rules defined earlier by anchors to be executed in each stage and leveraging sfpowerscripts orchestrator commands.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Schedule Jobs(s)**        | Scheduled jobs are filtered in the configuration file using the TARGETTASKNAME variable and only executed during their defined interval pattern.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Manual Jobs(s)**          | Manually triggered jobs from the pipeline will be filtered. Deployments to environments once the artifacts have been successfully published are controlled by manual triggers by the user.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |

## Pipeline Design

### Triggered Jobs

The diagram below depicts the various stages and jobs configured in the GitLab CI/CD configuration file .gitlab-ci.yml which incorporates the [sfpowerscripts orchestrator](https://sfpowerscripts.dxatscale.io/faq/orchestrator) and [sfpowerkit package](https://www.npmjs.com/package/sfpowerkit#sfpowerkitpackagevalid) commands to manage your CI/CD process. The grouping of stages and jobs are split into merge requests, merges, and manual triggers of the pipeline.

![](<../../.gitbook/assets/image (43).png>)

| Type          | Stage      | Job                | Command                                                                                                                                                                                                                                                                      | Description                                                                                     |
| ------------- | ---------- | ------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------- |
| Merge Request | Analyze    | analyze-pmd        | [analyze:pmd](https://www.npmjs.com/package/@dxatscale/sfpowerscripts#sfdx-sfpowerscriptsanalyzepmd)                                                                                                                                                                         | Static code analysis [PMD](https://pmd.github.io/latest/pmd\_rules\_apex.html)                  |
| Merge Request | Validate   | validate-package   | [package:valid](https://www.npmjs.com/package/sfpowerkit#sfpowerkitpackagevalid)                                                                                                                                                                                             | Validates against [metadata coverage](https://developer.salesforce.com/docs/metadata-coverage/) |
| Merge Request | Validate   | validate-source    | [orchestrator:validate](https://www.npmjs.com/package/@dxatscale/sfpowerscripts#sfdx-sfpowerscriptsorchestratorvalidate)                                                                                                                                                     | Validate deployment against scratch org                                                         |
| Merge         | Quickbuild | quickbuild         | [orchestrator:quickbuild](https://www.npmjs.com/package/@dxatscale/sfpowerscripts#sfdx-sfpowerscriptsorchestratorquickbuild)                                                                                                                                                 | Parallel build of packages without dependencies and code coverage                               |
| Merge         | Deploy     | deploy             | <p><a href="https://www.npmjs.com/package/sfpowerkit#sfpowerkitpackagedependenciesinstall">package:dependencies:install</a></p><p><a href="https://www.npmjs.com/package/@dxatscale/sfpowerscripts#sfdx-sfpowerscriptsorchestratordeploy">orchestrator:deploy</a></p>        | Install package dependencies and deploy packages                                                |
| Merge         | Build      | build              | <p><a href="https://www.npmjs.com/package/@dxatscale/sfpowerscripts#sfdx-sfpowerscriptsorchestratorbuild">orchestrator:build</a></p><p><a href="https://www.npmjs.com/package/@dxatscale/sfpowerscripts#sfdx-sfpowerscriptsorchestratorpublish">orchestrator:publish</a></p> | Build all packages and publish to artifact registry                                             |
| Manual        | Release    | ST, SIT, UAT, PROD | [orchestrator:release](https://www.npmjs.com/package/@dxatscale/sfpowerscripts#sfdx-sfpowerscriptsorchestratorrelease)                                                                                                                                                       | Release to Salesforce Org based on YAML file                                                    |

### Scheduled and Manual Jobs

The diagram below highlights the [dxatscale-template](https://github.com/dxatscale/dxatscale-template) recommended scheduled jobs and manual job for Scratch Org Pool Management. The stages and jobs configured in the GitLab CI/CD configuration file .gitlab-ci.yml uses the sfpowerscripts prepare commands to build scratch org pools for Developer and CI Scratch Orgs. Additional schedule job for publishing metrics to your dashboard platform is provided as well.

![](<../../.gitbook/assets/image (30) (1).png>)

| Type      | Stage   | Job               | Command                                                                                                                | Description                                           |
| --------- | ------- | ----------------- | ---------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------- |
| Scheduled | Prepare | prepare-ci-pool   | [orchestrator:prepare](https://www.npmjs.com/package/@dxatscale/sfpowerscripts#sfdx-sfpowerscriptsorchestratorprepare) | Prepares pool of CI Scratch Orgs                      |
| Scheduled | Prepare | prepare-dev-pool  | [orchestrator:prepare](https://www.npmjs.com/package/@dxatscale/sfpowerscripts#sfdx-sfpowerscriptsorchestratorprepare) | Prepares pool of Developer Scratch Orgs               |
| Scheduled | Clean   | clean-ci-pool     | [pool:delete](https://www.npmjs.com/package/@dxatscale/sfpowerscripts#sfdx-sfpowerscriptspooldelete)                   | Deletes specified tagged CI Scratch Org Pool          |
| Scheduled | Clean   | clean-dev-pool    | [pool:delete](https://www.npmjs.com/package/@dxatscale/sfpowerscripts#sfdx-sfpowerscriptspooldelete)                   | Deletes specified tagged Developer Scratch Org Pool   |
| Scheduled | Report  | report-so-count   | pool:metrics:publish                                                                                                   | Publish metrics to Dashboard                          |
| Manual    | Delete  | delete-fetched-so | [pool:org:delete](https://www.npmjs.com/package/@dxatscale/sfpowerscripts#sfdx-sfpowerscriptspooldelete)               | Deletes specified scratch org from provided user name |

## Dashboard Metrics

Metrics should be a key part of your DevOps process. It is through these metrics, one can drive continuous improvement of your delivery process.

The [dxatscale-template](https://github.com/dxatscale/dxatscale-template) includes sample [cicd-dashboard.json](https://github.com/dxatscale/dxatscale-template/tree/main/dashboards/NewRelic) file for NewRelic enables you to push StatsD metrics to the platform and monitor key metrics. Integration and setup of this is available in the Getting Started section.

The following variables are required to be setup in your project variables to push the metrics to New Relic.

* SFPOWERSCRIPTS\_NEWRELIC _(Optional)_
* SFPOWERSCRIPTS\_NEWRELIC\_API\_KEY _(Optional)_

Read more about Dashboards and Metrics [here](https://sfpowerscripts.dxatscale.io/faq/metrics-and-dashboards).

## Configuration Options

There are additional configurations for the GitLab Project that should be reviewed and configured to ensure it aligns with your internal IT policies.

* [Merge requests](https://docs.gitlab.com/ee/user/project/merge\_requests/) - Merge method, merge options, merge checks, merge suggestions should be reviewed to determine preferred approaches such as **merge commits**, **deleting source branches** by default option, and allowing **squash commits** when merging.

{% hint style="info" %}
DX@Scale recommends [squash commits](https://docs.dxatscale.io/scm/branching-model/branching-conventions#commit-message) when merging to provide succinct release notes during change log creation.
{% endhint %}

* [Merge request approvals](https://docs.gitlab.com/ee/user/admin\_area/merge\_requests\_approvals.html#merge-request-approval-rules) **\*\*- Merge request approval rules prevent users from overriding certain settings on the project level. Define the** number of approvals\*\* required for merging into specific branches and specify users or groups that are allowed to approve them in the approval rules.
* [Repository Settings](https://docs.gitlab.com/ee/user/project/repository/#repository) - A number of configurations for the repository can be reviewed and change such as default branches, [push rules](https://docs.gitlab.com/ee/push\_rules/push\_rules.html), [protected branches](https://docs.gitlab.com/ee/user/project/protected\_branches.html) and [protected tags](https://docs.gitlab.com/ee/user/project/protected\_tags.html). Limit the restrictions where possible to not create bottlenecks for the pipeline and developers.
* [CI/CD Settings](https://docs.gitlab.com/ee/ci/) - [Runners](https://docs.gitlab.com/runner/) can be configured to be shared or specified. [Environments](https://docs.gitlab.com/ee/ci/environments/protected\_environments.html) can be setup for protection in the CI/CD.
* [Clean Scratch Org Pools](https://docs.dxatscale.io/environment/pooling-scratch-orgs) - The clean-pool stage in the [.gitlab-ci.yml](https://docs.gitlab.com/ee/ci/) file can be split into separate stages to hand the deletion of unused developer scratch orgs and CI scratch orgs.

{% hint style="info" %}
[Releases](https://docs.gitlab.com/ee/user/project/releases/#releases) in GitLab are not used by the dxatscale-template as we leverage our own release management process through the sfpowerscripts orchestrator and package registry. We will revisit the potential use of this feature in GitLab in the future if there is a need.
{% endhint %}

## Design Considerations

The following are additional design configurations to consider when using this template:

1. [Public Docker Registry](https://docs.docker.com/registry/) vs. [Project Container Registry](https://docs.gitlab.com/ee/administration/packages/container\_registry.html#gitlab-container-registry-administration)
2. [Public DX@Scale Pre-requisite Unlocked Packages](https://github.com/Accenture/sfpowerscripts/tree/develop/prerequisites) vs. [DevHub Unlocked Package ](https://developer.salesforce.com/docs/atlas.en-us.sfdx\_dev.meta/sfdx\_dev/sfdx\_dev\_unlocked\_pkg\_intro.htm)for [Scratch Org Pool](https://github.com/Accenture/sfpowerscripts/tree/develop/prerequisites/scratchorgpool) and [sfpowerscripts-artifact](https://github.com/Accenture/sfpowerscripts/tree/develop/prerequisites/sfpowerscripts-artifact)
3. [GitLab Self-Managed](https://about.gitlab.com/pricing/self-managed/feature-comparison/) vs. [GitLab SaaS](https://about.gitlab.com/pricing/gitlab-com/feature-comparison/)
4. [Project NPM Package Registry](https://docs.gitlab.com/ee/user/packages/npm\_registry/index.html) vs. [External NPM Package Registry](https://docs.npmjs.com/cli/v7/using-npm/registry)
5. [Project CI/CD Variables](https://docs.gitlab.com/ee/ci/variables/) vs. [External Secrets Provider](https://docs.gitlab.com/ee/ci/secrets/)
6. [Multi-Repository Checkout Support](https://about.gitlab.com/blog/2018/10/31/use-multiproject-pipelines-with-gitlab-cicd/)
7. [Release Gates Approval Process](https://docs.gitlab.com/ee/development/approval\_rules.html#approval-rules-development-guide)
8. [Operational Dashboard Tooling](https://sfpowerscripts.dxatscale.io/faq/metrics-and-dashboards)
9. [ALM Integration](https://docs.gitlab.com/ee/user/project/integrations/overview.html#integrations) vs. [GitLab Issue Management Tool](https://docs.gitlab.com/ee/topics/plan\_and\_track.html)
10. [Protected Branches](https://docs.gitlab.com/ee/user/project/protected\_branches.html)
11. [Merge Request Rules](https://docs.gitlab.com/ee/user/project/merge\_requests/) (eg. Squash commits when merging)
12. [Merge request (MR) approvals](https://docs.gitlab.com/ee/user/admin\_area/merge\_requests\_approvals.html#merge-request-approval-rules)
13. Security Requirements - [Access Tokens](https://docs.gitlab.com/ee/user/profile/personal\_access\_tokens.html#personal-access-tokens) and [SSH Keys](https://docs.gitlab.com/ee/ssh/index.html#gitlab-and-ssh-keys)
14. Security Design - [Permissions and Roles](https://docs.gitlab.com/ee/user/permissions.html) Assignment to Users
15. [Organization Setup, Groups, Sub-Groups](https://docs.gitlab.com/ee/topics/set\_up\_organization.html)
16. Naming Conventions for [Repositories](https://docs.gitlab.com/ee/user/project/repository/) and [Environments](https://docs.gitlab.com/ee/ci/environments/)
17. Automated Testing Integration
18. Static Code Analysis Integration
19. Dynamic Code Testing Integration

## FAQs

#### Why is the Access Tokens menu not available to configure my Project Access Tokens?

For GitLab SaaS hosting, Project Access Tokens are only available for Premium and above licenses and self-managed instances on Free tier and above.

## References

* [GitLab Official Documentation](https://docs.gitlab.com/ee/topics/use\_gitlab.html)
* [GitLab CLI Tool](https://glab.readthedocs.io/en/latest/)
* [Keyword reference for the .gitlab-ci.yml file (FREE)](https://microfluidics.utoronto.ca/gitlab/help/ci/yaml/index.md)
* [Using external secrets in CI](https://docs.gitlab.com/ee/ci/secrets/)
* [Bash scripting cheatsheet](https://devhints.io/bash)
* [Semantic Versioning](https://semver.org)
* [NPM Packages and Modules](https://docs.npmjs.com/about-packages-and-modules)
* [YAML: YAML Ain't Markup Language](https://yaml.org)
* [DX@Scale GitBook](https://docs.dxatscale.io)
* [SFPowerscripts GitBook](https://sfpowerscripts.dxatscale.io)
* [Using external secrets in CI](https://docs.gitlab.com/ee/ci/secrets/)
* [StatsD](https://github.com/statsd/statsd)

## Tutorials

* [Scheduled and On Demand Jobs with Run Pipeline Form](https://gitlab.com/guided-explorations/gitlab-ci-yml-tips-tricks-and-hacks/scheduled-and-on-demand-tasks/-/tree/master)
* [GitLab environment variables demystified](https://about.gitlab.com/blog/2021/04/09/demystifying-ci-cd-variables/)
* [First time GitLab & CI/CD workshop with Michael Friedrich](https://www.youtube.com/watch?v=kTNfi5z6Uvk\&t=553s)
